<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/device.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/device.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module node-liveosc
 * @author Tom Dinchak &lt;dinchak@gmail.com>
 */

var EventEmitter = require('events').EventEmitter;
var _ = require('underscore');

/**
 * Device object, represents a device in the Ableton Live set.
 * @constructor
 * @param {Object} liveosc LiveOSC instance
 * @param {Number} id      id of the device
 * @param {Object} track   track the device belongs to
 * @param {String} type    type of device's track ('track', 'return', 'master')
 * @param {String} name    name of the device
 */
var Device = function (liveosc, id, track, type, name) {

  /**
   * Instance of LiveOSC
   * @type {Object}
   */
  this.liveosc = liveosc;

  /**
   * The name of this device
   * @type {String}
   */
  this.name = name;

  /**
   * The id of this device
   * @type {Number}
   */
  this.id = id;

  /**
   * The track this device belongs to
   * @type {Object}
   */
  this.track = track;

  /**
   * The type of track the device is on, valid types are:
   * 
   *   master
   *   track
   *   return
   *   
   * @type {String}
   */
  this.type = type;

  /**
   * The parameter values of a device, format of a parameter is:
   *
   *   {
   *     id: 0,
   *     value: 1,
   *     name: 'Device On',
   *     min: 0,
   *     max: 1
   *   }
   * 
   * @type {Array}
   */
  this.params = [];

  /**
   * EventEmitter for device events
   * @type {EventEmitter}
   */
  this.eventEmitter = new EventEmitter();

  var self = this;

  // determine listener addresses based on track type
  var infoAddr = '/live/device';
  var rangeAddr = '/live/device/range';
  var paramAddr = '/live/device/param';
  var allParamAddr = '/live/device/allparam';
  if (type != 'track') {
    infoAddr = '/live/' + type + '/device';
    rangeAddr = '/live/' + type + '/device/range';
    paramAddr = '/live/' + type + '/device/param';
    allParamAddr = '/live/' + type + '/device/allparam';
    if (type == 'master') {
      allParamAddr = '/live/master/device';
    }
  }

  /**
   * Listen for /live/device/range
   */
  function rangeListener() {
    var args = Array.prototype.slice.call(arguments, 0);
    if (type != 'master') {
      var trackId = args.shift();
      if (trackId != self.track.id) return;
    }
    var deviceId = args.shift();
    if (deviceId != self.id) return;
    for (var i = 0; i &lt; args.length; i += 3) {
      if (!self.params[args[i]]) {
        self.params[args[i]] = {};
      }
      var param = self.params[args[i]];
      param.min = args[i + 1];
      param.max = args[i + 2];
    }
  }

  /**
   * Listen for /live/device/allparam
   */
  function allParamListener() {
    var args = Array.prototype.slice.call(arguments, 0);
    if (type != 'master') {
      var trackId = args.shift();
      if (trackId != self.track.id) return;
    }
    var deviceId = args.shift();
    if (deviceId != self.id) return;
    for (var i = 0; i &lt; args.length; i += 3) {
      if (!self.params[args[i]]) {
        self.params[args[i]] = {};
      }
      var param = self.params[args[i]];
      if (param.value != args[i + 1]) {
        self.eventEmitter.emit('param', {
          name: args[i + 2],
          value: args[i + 1],
          prev: param.value
        });
        self.eventEmitter.emit(args[i + 2], {
          value: args[i + 1],
          prev: param.value
        });
      }
      param.id = args[i];
      param.value = args[i + 1];
      param.name = args[i + 2];
    }
  }

  /**
   * Listen for /live/device/param
   */
  function paramListener() {
    var args = Array.prototype.slice.call(arguments, 0);
    if (type != 'master') {
      var trackId = args.shift();
      if (trackId != self.track.id) return;
    }
    var deviceId = args.shift();
    if (deviceId != self.id) return;
    if (!self.params[args[0]]) {
      self.params[args[0]] = {};
    }
    var param = self.params[args[0]];
    self.eventEmitter.emit('param', {
      name: args[2],
      value: args[1],
      prev: param.value
    });
    self.eventEmitter.emit(args[2], {
      value: args[1],
      prev: param.value
    });
    param.id = args[0];
    param.value = args[1];
    param.name = args[2];
  }

  liveosc.receiver.on(rangeAddr, rangeListener);
  liveosc.receiver.on(allParamAddr, allParamListener);
  liveosc.receiver.on(paramAddr, paramListener);

  var args = [infoAddr];
  if (type != 'master') {
    args.push({type: 'integer', value: track.id});
  }
  args.push({type: 'integer', value: id});
  liveosc.emitter.emit.apply(liveosc.emitter, args);

  var args = [rangeAddr];
  if (type != 'master') {
    args.push({type: 'integer', value: track.id});
  }
  args.push({type: 'integer', value: id});
  liveosc.emitter.emit.apply(liveosc.emitter, args);

  /**
   * Called when a device is refreshed or destroyed
   */
  this.destroy = function () {
    self.eventEmitter.emit('destroy');
    self.eventEmitter.removeAllListeners();
    self.liveosc.receiver.removeListener(rangeAddr, rangeListener);
    self.liveosc.receiver.removeListener(paramAddr, paramListener);
    self.liveosc.receiver.removeListener(allParamAddr, allParamListener);
  };
};

/**
 * Set a device parameter to a value
 * @param {Mixed}  param id of the parameter or name of the parameter
 * @param {Number} value new parameter value
 */
Device.prototype.set = function (param, value) {
  var addr;
  if (this.type == 'track') {
    addr = '/live/device';
  } else {
    addr = '/live/' + this.type + '/device';
  }
  var args = [addr];
  if (this.type != 'master') {
    args.push({type: 'integer', value: this.track.id});
  }
  args.push({type: 'integer', value: this.id});
  if (typeof param == 'string') {
    var prm = _.findWhere(this.params, {name: param});
    if (prm) {
      param = prm.id;
    } else {
      throw new Error('No parameter with name ' + param);
    }
  }
  args.push({type: 'integer', value: param});
  args.push({type: 'integer', value: value});
  this.liveosc.emitter.emit.apply(
    this.liveosc.emitter,
    args
  );
};

/**
 * Focus this device
 */
Device.prototype.view = function () {
  var args = ['/live/' + this.type + '/device/view'];
  if (this.type != 'master') {
    args.push({type: 'integer', value: this.id});
  }
  args.push({type: 'integer', value: this.id});
  this.liveosc.emitter.emit.apply(
    this.liveosc.emitter,
    args
  );
};

/**
 * Listen for a device event, current events are:
 *
 *   param
 *     * fired on any parameter change
 *   &lt;name of the parameter>
 *     * listen for a specific parameter
 *   destroy
 *   
 * @param  {String}   ev event name
 * @param  {Function} cb callback
 */
Device.prototype.on = function (ev, cb) {
  this.eventEmitter.on(ev, cb);
};

module.exports = Device;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-node-liveosc.html">node-liveosc</a></li></ul><h3>Classes</h3><ul><li><a href="module-node-liveosc-Clip.html">Clip</a></li><li><a href="module-node-liveosc-Device.html">Device</a></li><li><a href="module-node-liveosc-LiveOSC.html">LiveOSC</a></li><li><a href="module-node-liveosc-Return.html">Return</a></li><li><a href="module-node-liveosc-Song.html">Song</a></li><li><a href="module-node-liveosc-Track.html">Track</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Sun Jul 13 2014 14:45:08 GMT-0700 (MST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
